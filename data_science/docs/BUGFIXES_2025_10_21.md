# üêõ Critical Bugfixes Applied - October 21, 2025

## Summary
Fixed multiple critical bugs preventing plots and tool results from appearing in the UI.

---

## üî¥ Bug #1: Plot Tool Not Generating Plots (0.00s Execution)

### Problem
- `plot_tool_guard` was completing in **0.00-0.01 seconds** (impossibly fast)
- No plots were being generated despite "success" status
- No files were being saved to disk

### Root Cause
```python
# ‚ùå BEFORE: plot_tool_guard was SYNC, calling async function without await
def plot_tool_guard(tool_context=None, **kwargs):
    result = _plot_inner(tool_context=tool_context, **kwargs)  # ‚ùå No await!
    # This returned a coroutine object, never executed it
```

The guard was calling `plot_tool` (which is **async**) but **not awaiting** it, so:
1. The coroutine was never executed
2. No plots were generated
3. But no error was raised, so it appeared to "succeed"

### Fix Applied
```python
# ‚úÖ AFTER: plot_tool_guard is now ASYNC and awaits the plot_tool
async def plot_tool_guard(tool_context=None, **kwargs):
    logger.info("[PLOT GUARD] Starting plot generation")
    
    # Ensure workspace exists first
    ensure_workspace(state, UPLOAD_ROOT)
    
    # ‚úÖ AWAIT the async plot_tool!
    result = await _plot_inner(tool_context=tool_context, **kwargs)
    
    logger.info(f"[PLOT GUARD] plot_tool returned: {type(result)}")
    # ... rest of guard logic
```

**Files Changed:**
- `data_science/plot_tool_guard.py` (made async, added await, added logging)

---

## üî¥ Bug #2: Tool Results Not Showing in UI

### Problem
- `head` and `describe` tool results were not appearing in the chat
- Tool execution succeeded but users saw no output
- Data previews and summaries were invisible

### Root Cause #1: Minimal Message Formatting
The guards were only returning generic success messages like:
```python
result["message"] = "üìä Data preview generated successfully"  # ‚ùå Not helpful!
```

But the actual **data** (tables, statistics) was in the result dict, not in the message.

### Root Cause #2: ADK Doesn't Auto-Display Tool Results
ADK does **NOT** automatically show tool return values as assistant messages. The tool result goes to the LLM, which then decides whether to summarize it. But with streaming or immediate turn-ending, users never see it.

### Fix Applied

#### Part 1: Format Rich, Readable Messages
```python
# ‚úÖ AFTER: head_tool_guard formats actual data as markdown table
def head_tool_guard(tool_context=None, **kwargs):
    result = _head_inner(tool_context=tool_context, **kwargs)
    
    message_parts = ["üìä **Data Preview (First Rows)**\n"]
    
    if "head" in result and result["head"]:
        df = pd.DataFrame(result["head"])
        table_md = df.head(5).to_markdown(index=False)
        message_parts.append(f"```\n{table_md}\n```")
    
    if "shape" in result:
        message_parts.append(f"\n**Shape:** {result['shape'][0]} rows √ó {result['shape'][1]} columns")
    
    if "columns" in result:
        cols = result["columns"][:10]
        message_parts.append(f"\n**Columns:** {', '.join(map(str, cols))}")
    
    formatted_message = "\n".join(message_parts)
    result["message"] = formatted_message
    result["ui_text"] = formatted_message
    return result
```

Similarly for `describe_tool_guard` - now formats JSON statistics, feature counts, etc.

#### Part 2: Inject Tool Results as Assistant Messages
```python
# ‚úÖ AFTER: callbacks.py actively promotes tool results to chat
async def after_tool_callback(*, tool=None, tool_context=None, result=None, **kwargs):
    # ... existing logic ...
    
    # Promote tool result text to the chat stream as an assistant message
    if isinstance(result, dict):
        ui_text = result.get("ui_text") or result.get("message") or result.get("summary")
        if ui_text and ui_text.strip():
            logger.info(f"[CALLBACK] Promoting tool result to UI: {ui_text[:100]}...")
            
            try:
                from google.genai import types as gen_types
                text_part = gen_types.Part.from_text(ui_text[:4000])
                
                # Try various ADK methods to inject assistant message
                if hasattr(callback_context, 'add_assistant_message'):
                    callback_context.add_assistant_message(text_part)
                elif hasattr(callback_context, 'reply'):
                    callback_context.reply(ui_text[:4000])
                elif hasattr(callback_context, 'add_content'):
                    callback_context.add_content(text_part)
                else:
                    # Fallback: store in state
                    callback_context.state["_tool_result_to_display"] = ui_text[:4000]
            except Exception as e:
                logger.warning(f"[CALLBACK] Failed to add assistant message: {e}")
```

**Files Changed:**
- `data_science/head_describe_guard.py` (rich formatting, logging)
- `data_science/callbacks.py` (message promotion logic)

---

## üìä Expected Behavior After Fix

### Plot Generation
```
[PLOT GUARD] Starting plot generation
[PLOT GUARD] Workspace ensured: C:\.uploaded\_workspaces\dataset\20251021_145102
[PLOT GUARD] Calling plot_tool (async)...
[PLOT] Starting plot generation
[PLOT] DataFrame loaded: shape=(244, 7)
[PLOT] Saving plot to: C:\...\plots\heatmap_20251021_145102.png
[PLOT] ‚úÖ Successfully saved plot to ...heatmap.png, size=25000 bytes
[PLOT GUARD] ‚úÖ Complete. Generated 5 plots, shown 5 names

User sees:
üìä Plots generated and uploaded to **Artifacts**:
- heatmap_20251021_145102.png
- distribution_20251021_145102.png
- correlation_20251021_145102.png
...
```

### Head Tool
```
[HEAD GUARD] Starting head tool
[HEAD GUARD] Formatted message length: 342

User sees:
üìä **Data Preview (First Rows)**

| col1 | col2 | col3 |
|------|------|------|
| 1    | 2    | 3    |
| 4    | 5    | 6    |
...

**Shape:** 244 rows √ó 7 columns
**Columns:** col1, col2, col3, ...
```

### Describe Tool
```
[DESCRIBE GUARD] Starting describe tool
[DESCRIBE GUARD] Formatted message length: 580

User sees:
üìà **Data Summary & Statistics**

```json
{
  "numeric_features": ["age", "income"],
  "categorical_features": ["gender", "city"],
  "missing_values": {"age": 5, "income": 2}
}
```

**Dataset Shape:** 244 rows √ó 7 columns
**Total Columns:** 7
**Numeric Features:** 2
**Categorical Features:** 5
```

---

## üîç How to Verify

1. **Upload a CSV file**
2. **Run plot command**: `generate plots` or `visualize data`
   - Should see `[PLOT GUARD]` logs in console
   - Should take 2-5 seconds (not 0.00s)
   - Should see PNG files created in `.uploaded/_workspaces/<dataset>/<timestamp>/plots/`
   - Should see plots in Artifacts pane

3. **Run head command**: `show me the first few rows`
   - Should see formatted markdown table in chat
   - Should see column names and shape

4. **Run describe command**: `describe the data` or `show summary statistics`
   - Should see JSON-formatted statistics
   - Should see feature counts

---

## üö® Potential Issues to Watch

1. **ADK Message Injection**: If `callback_context.add_assistant_message()` (or similar) is not available in your ADK version, tool results will be stored in state but might not display automatically. Check logs for:
   ```
   [CALLBACK] ‚ö†Ô∏è No known method to add assistant message, stored in state
   ```

2. **Markdown Formatting**: Some UI clients might not render markdown tables correctly. The fallback is plain text.

3. **Large Results**: Tool results are truncated to 4000 characters to avoid overwhelming the UI.

---

## üìù Testing Checklist

- [ ] Plots are generated (check logs for `[PLOT]` messages taking >1 second)
- [ ] Plot PNG files exist on disk in workspace/plots/
- [ ] Plots appear in Artifacts pane
- [ ] Head tool shows formatted table in chat
- [ ] Describe tool shows JSON statistics in chat
- [ ] All tool execution times are reasonable (not 0.00s)
- [ ] No coroutine warnings in logs

---

## üéØ Next Steps

If tool results still don't appear in chat:
1. Check `agent.log` for `[CALLBACK]` messages
2. Look for which method was used: `add_assistant_message`, `reply`, `add_content`, or fallback
3. If fallback was used, the tool result is in `callback_context.state["_tool_result_to_display"]`
4. You may need to modify the agent's system prompt to instruct it to check `state["_tool_result_to_display"]` and echo it

---

## üìö Files Modified

1. `data_science/plot_tool_guard.py` - Made async, added await, added logging
2. `data_science/head_describe_guard.py` - Rich message formatting, logging
3. `data_science/callbacks.py` - Message promotion to chat UI

All changes are backward compatible and safe to deploy.

